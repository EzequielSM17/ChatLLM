<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:ViewModels"
             xmlns:models="clr-namespace:Models"
             x:Class="Views.MainPage"
             x:DataType="viewmodel:ChatViewModel"
             >

    <Grid RowDefinitions="Auto, *, Auto" Padding="10">

        <HorizontalStackLayout Grid.Row="0" Spacing="10" HorizontalOptions="Center">
            <ActivityIndicator IsRunning="{Binding IsLoading, Mode=TwoWay}" />
            <Label Text="{Binding StatusMessage, Mode=TwoWay}" VerticalOptions="Center" />
        </HorizontalStackLayout>

        <CollectionView Grid.Row="1" 
                x:Name="MessagesListView"
                ItemsSource="{Binding Messages}"
                SelectionMode="None">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="15" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Message">
                    <Grid Padding="15,2">
                        <Border x:Name="BubbleBorder"
                        Padding="15,10"
                        StrokeThickness="0"
                        HorizontalOptions="Start"
                        MaximumWidthRequest="640">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="18" />
                            </Border.StrokeShape>

                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="1,2" Radius="3" Opacity="0.1" />
                            </Border.Shadow>

                            <Label Text="{Binding Text}" 
                           TextColor="White"
                           FontSize="15"
                           LineBreakMode="WordWrap" />

                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsBot}" Value="False">
                                    <Setter Property="HorizontalOptions" Value="End" />
                                    <Setter Property="BackgroundColor" Value="#005C4B" />
                                    <Setter Property="Margin" Value="50,0,0,0" />
                                </DataTrigger>

                                <DataTrigger TargetType="Border" Binding="{Binding IsBot}" Value="True">
                                    <Setter Property="HorizontalOptions" Value="Start" />
                                    <Setter Property="BackgroundColor" Value="#202C33" />
                                    <Setter Property="Margin" Value="0,0,50,0" />
                                </DataTrigger>
                            </Border.Triggers>
                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <Button Grid.Row="2" 
        Text="INICIAR CONVERSACIÓN" 
        Command="{Binding ManualStartCommand}"
        IsEnabled="{Binding isLoading, Converter={StaticResource InvertedBoolConverter}}">

        </Button>
    </Grid>
</ContentPage>
